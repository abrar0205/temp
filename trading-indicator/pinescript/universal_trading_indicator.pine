// Universal Multi-Confirmation Trading Indicator v1.0
// Designed for NSE NIFTY 50, Bank NIFTY, and Global Markets
// TradingView Pine Script v5
// 
// Based on extensive backtesting research combining:
// - Trend Analysis (EMA crossovers, SuperTrend)
// - Momentum Confirmation (RSI with dynamic zones)
// - Volatility Filtering (ATR-based)
// - Volume Confirmation (OBV trend)
//
// References:
// - Connors RSI research (Larry Connors, TradingMarkets.com)
// - SuperTrend optimization studies (Various backtesting sources)
// - Moving Average crossover analysis (Liberated Stock Trader, 11,000+ trades)
// - Quantified Strategies backtesting data

//@version=5
indicator("Universal Multi-Confirmation Indicator [v1.0]", shorttitle="UMCI", overlay=true)

// ============================================================================
// INPUT PARAMETERS
// ============================================================================

// Trend Parameters
trendGroup = "Trend Settings"
fastEMA = input.int(9, title="Fast EMA Period", minval=2, maxval=50, group=trendGroup)
slowEMA = input.int(21, title="Slow EMA Period", minval=5, maxval=100, group=trendGroup)
superTrendPeriod = input.int(10, title="SuperTrend Period", minval=1, maxval=50, group=trendGroup)
superTrendMult = input.float(3.0, title="SuperTrend Multiplier", minval=0.5, maxval=5.0, step=0.1, group=trendGroup)

// Momentum Parameters
momentumGroup = "Momentum Settings"
rsiPeriod = input.int(14, title="RSI Period", minval=2, maxval=50, group=momentumGroup)
rsiOversold = input.int(40, title="RSI Oversold Level", minval=10, maxval=50, group=momentumGroup)
rsiOverbought = input.int(60, title="RSI Overbought Level", minval=50, maxval=90, group=momentumGroup)

// Volatility Parameters
volatilityGroup = "Volatility Settings"
atrPeriod = input.int(14, title="ATR Period", minval=1, maxval=50, group=volatilityGroup)
atrMinMultiplier = input.float(0.5, title="ATR Min Multiplier (Filter Low Vol)", minval=0.1, maxval=2.0, step=0.1, group=volatilityGroup)
atrMaxMultiplier = input.float(3.0, title="ATR Max Multiplier (Filter High Vol)", minval=1.0, maxval=5.0, step=0.1, group=volatilityGroup)

// Volume Parameters
volumeGroup = "Volume Settings"
useVolumeFilter = input.bool(true, title="Use Volume Confirmation", group=volumeGroup)
obvEMAPeriod = input.int(20, title="OBV EMA Period", minval=5, maxval=50, group=volumeGroup)

// Risk Management Parameters
riskGroup = "Risk Management"
stopLossATRMult = input.float(2.0, title="Stop Loss (ATR Multiplier)", minval=0.5, maxval=5.0, step=0.1, group=riskGroup)
takeProfitATRMult = input.float(3.0, title="Take Profit (ATR Multiplier)", minval=1.0, maxval=10.0, step=0.5, group=riskGroup)

// Display Settings
displayGroup = "Display Settings"
showSignals = input.bool(true, title="Show Buy/Sell Signals", group=displayGroup)
showTrendBackground = input.bool(true, title="Show Trend Background", group=displayGroup)
showSLTP = input.bool(true, title="Show SL/TP Levels", group=displayGroup)
showInfoTable = input.bool(true, title="Show Info Table", group=displayGroup)

// ============================================================================
// TREND CALCULATIONS
// ============================================================================

// EMA Calculations
emaFast = ta.ema(close, fastEMA)
emaSlow = ta.ema(close, slowEMA)

// EMA Trend Direction
emaTrendUp = emaFast > emaSlow
emaTrendDown = emaFast < emaSlow

// SuperTrend Calculation
atr = ta.atr(superTrendPeriod)
upperBand = hl2 + (superTrendMult * atr)
lowerBand = hl2 - (superTrendMult * atr)

var float superTrendUpperBand = na
var float superTrendLowerBand = na
var int superTrendDirection = 1

superTrendLowerBand := close[1] > nz(superTrendLowerBand[1], lowerBand) ? math.max(lowerBand, nz(superTrendLowerBand[1], lowerBand)) : lowerBand
superTrendUpperBand := close[1] < nz(superTrendUpperBand[1], upperBand) ? math.min(upperBand, nz(superTrendUpperBand[1], upperBand)) : upperBand

superTrendDirection := close > nz(superTrendUpperBand[1], upperBand) ? 1 : close < nz(superTrendLowerBand[1], lowerBand) ? -1 : nz(superTrendDirection[1], 1)

superTrend = superTrendDirection == 1 ? superTrendLowerBand : superTrendUpperBand
superTrendBullish = superTrendDirection == 1

// Combined Trend Signal (EMA + SuperTrend agreement)
strongUptrend = emaTrendUp and superTrendBullish
strongDowntrend = emaTrendDown and not superTrendBullish

// ============================================================================
// MOMENTUM CALCULATIONS
// ============================================================================

// RSI Calculation
rsi = ta.rsi(close, rsiPeriod)

// RSI Conditions
rsiBullish = rsi > rsiOversold and rsi < rsiOverbought and rsi > rsi[1]  // Rising RSI in favorable zone
rsiBearish = rsi > rsiOversold and rsi < rsiOverbought and rsi < rsi[1]  // Falling RSI in favorable zone
rsiOversoldCondition = rsi < rsiOversold
rsiOverboughtCondition = rsi > rsiOverbought

// ============================================================================
// VOLATILITY FILTER
// ============================================================================

// ATR for volatility measurement
atrVolatility = ta.atr(atrPeriod)
atr20 = ta.sma(atrVolatility, 20)  // 20-period average ATR for comparison

// Volatility within acceptable range
atrRatio = atrVolatility / atr20
volatilityOK = atrRatio >= atrMinMultiplier and atrRatio <= atrMaxMultiplier

// ============================================================================
// VOLUME CALCULATIONS
// ============================================================================

// OBV Calculation
obv = ta.obv
obvEMA = ta.ema(obv, obvEMAPeriod)

// Volume Confirmation
volumeConfirmBull = not useVolumeFilter or (obv > obvEMA)
volumeConfirmBear = not useVolumeFilter or (obv < obvEMA)

// ============================================================================
// SIGNAL GENERATION (Multi-Confirmation)
// ============================================================================

// Buy Signal Requirements:
// 1. Strong uptrend (EMA + SuperTrend)
// 2. RSI not overbought and improving
// 3. Volatility within acceptable range
// 4. Volume confirmation (OBV above EMA)
buySignal = strongUptrend and rsiBullish and volatilityOK and volumeConfirmBull and not strongUptrend[1]

// Sell Signal Requirements:
// 1. Strong downtrend (EMA + SuperTrend)
// 2. RSI not oversold and declining
// 3. Volatility within acceptable range
// 4. Volume confirmation (OBV below EMA)
sellSignal = strongDowntrend and rsiBearish and volatilityOK and volumeConfirmBear and not strongDowntrend[1]

// Exit Signals
exitLong = strongDowntrend or rsiOverboughtCondition
exitShort = strongUptrend or rsiOversoldCondition

// ============================================================================
// STOP LOSS / TAKE PROFIT CALCULATION
// ============================================================================

var float entryPrice = na
var float stopLoss = na
var float takeProfit = na
var int tradeDirection = 0  // 1 = long, -1 = short, 0 = flat

if buySignal
    entryPrice := close
    stopLoss := close - (atrVolatility * stopLossATRMult)
    takeProfit := close + (atrVolatility * takeProfitATRMult)
    tradeDirection := 1
else if sellSignal
    entryPrice := close
    stopLoss := close + (atrVolatility * stopLossATRMult)
    takeProfit := close - (atrVolatility * takeProfitATRMult)
    tradeDirection := -1
else if (tradeDirection == 1 and exitLong) or (tradeDirection == -1 and exitShort)
    entryPrice := na
    stopLoss := na
    takeProfit := na
    tradeDirection := 0

// ============================================================================
// VISUAL DISPLAY
// ============================================================================

// Plot EMAs
plot(emaFast, color=color.new(color.blue, 0), linewidth=1, title="Fast EMA")
plot(emaSlow, color=color.new(color.orange, 0), linewidth=1, title="Slow EMA")

// Plot SuperTrend
plot(superTrend, color=superTrendBullish ? color.green : color.red, linewidth=2, title="SuperTrend")

// Trend Background
bgcolor(showTrendBackground ? (strongUptrend ? color.new(color.green, 90) : strongDowntrend ? color.new(color.red, 90) : na) : na)

// Buy/Sell Signals
plotshape(showSignals and buySignal, title="Buy Signal", location=location.belowbar, style=shape.triangleup, size=size.normal, color=color.green, text="BUY")
plotshape(showSignals and sellSignal, title="Sell Signal", location=location.abovebar, style=shape.triangledown, size=size.normal, color=color.red, text="SELL")

// Exit Signals
plotshape(showSignals and exitLong and tradeDirection[1] == 1, title="Exit Long", location=location.abovebar, style=shape.xcross, size=size.small, color=color.orange, text="EXIT")
plotshape(showSignals and exitShort and tradeDirection[1] == -1, title="Exit Short", location=location.belowbar, style=shape.xcross, size=size.small, color=color.orange, text="EXIT")

// SL/TP Lines
plot(showSLTP and tradeDirection != 0 ? stopLoss : na, color=color.red, style=plot.style_linebr, linewidth=1, title="Stop Loss")
plot(showSLTP and tradeDirection != 0 ? takeProfit : na, color=color.green, style=plot.style_linebr, linewidth=1, title="Take Profit")

// ============================================================================
// INFORMATION TABLE
// ============================================================================

if showInfoTable
    var table infoTable = table.new(position.top_right, 2, 10, bgcolor=color.new(color.black, 80), border_width=1)
    
    table.cell(infoTable, 0, 0, "UMCI v1.0", text_color=color.white, bgcolor=color.new(color.blue, 50))
    table.cell(infoTable, 1, 0, "Status", text_color=color.white, bgcolor=color.new(color.blue, 50))
    
    table.cell(infoTable, 0, 1, "Trend", text_color=color.white)
    table.cell(infoTable, 1, 1, strongUptrend ? "BULLISH" : strongDowntrend ? "BEARISH" : "NEUTRAL", text_color=strongUptrend ? color.green : strongDowntrend ? color.red : color.gray)
    
    table.cell(infoTable, 0, 2, "RSI", text_color=color.white)
    table.cell(infoTable, 1, 2, str.tostring(rsi, "#.##"), text_color=rsi > 60 ? color.orange : rsi < 40 ? color.aqua : color.white)
    
    table.cell(infoTable, 0, 3, "ATR Ratio", text_color=color.white)
    table.cell(infoTable, 1, 3, str.tostring(atrRatio, "#.##"), text_color=volatilityOK ? color.green : color.red)
    
    table.cell(infoTable, 0, 4, "Vol Filter", text_color=color.white)
    table.cell(infoTable, 1, 4, volumeConfirmBull ? "BULLISH" : volumeConfirmBear ? "BEARISH" : "NEUTRAL", text_color=volumeConfirmBull ? color.green : volumeConfirmBear ? color.red : color.gray)
    
    table.cell(infoTable, 0, 5, "Signal", text_color=color.white)
    table.cell(infoTable, 1, 5, buySignal ? "BUY" : sellSignal ? "SELL" : "WAIT", text_color=buySignal ? color.green : sellSignal ? color.red : color.gray)
    
    if tradeDirection != 0
        table.cell(infoTable, 0, 6, "Entry", text_color=color.white)
        table.cell(infoTable, 1, 6, str.tostring(entryPrice, "#.##"), text_color=color.white)
        
        table.cell(infoTable, 0, 7, "Stop Loss", text_color=color.white)
        table.cell(infoTable, 1, 7, str.tostring(stopLoss, "#.##"), text_color=color.red)
        
        table.cell(infoTable, 0, 8, "Take Profit", text_color=color.white)
        table.cell(infoTable, 1, 8, str.tostring(takeProfit, "#.##"), text_color=color.green)
        
        riskReward = math.abs(takeProfit - entryPrice) / math.abs(entryPrice - stopLoss)
        table.cell(infoTable, 0, 9, "Risk:Reward", text_color=color.white)
        table.cell(infoTable, 1, 9, "1:" + str.tostring(riskReward, "#.#"), text_color=color.yellow)

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(buySignal, title="Buy Signal", message="UMCI: Buy Signal on {{ticker}} at {{close}}")
alertcondition(sellSignal, title="Sell Signal", message="UMCI: Sell Signal on {{ticker}} at {{close}}")
alertcondition(exitLong, title="Exit Long", message="UMCI: Exit Long on {{ticker}} at {{close}}")
alertcondition(exitShort, title="Exit Short", message="UMCI: Exit Short on {{ticker}} at {{close}}")
