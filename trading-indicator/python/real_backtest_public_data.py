"""
Real Data Backtesting with Public Data Sources
Fetches actual market data from public datasets and runs UMCI backtest
"""

import json
import csv
import io
import sys
import os
from datetime import datetime
from urllib.request import urlopen
from urllib.error import URLError

# Add parent directory for imports
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))
from backtest import BacktestConfig, run_backtest, print_results, BacktestResults

# Public data sources (GitHub datasets)
DATA_SOURCES = {
    "AAPL": "https://raw.githubusercontent.com/plotly/datasets/master/finance-charts-apple.csv",
    "GOOGL": "https://raw.githubusercontent.com/plotly/datasets/master/finance-charts-google.csv",
    "AMZN": "https://raw.githubusercontent.com/plotly/datasets/master/finance-charts-amzn.csv",
    "IBM": "https://raw.githubusercontent.com/plotly/datasets/master/timeseries.csv",
    "MSFT": "https://raw.githubusercontent.com/datasets/finance-vix/master/data/vix-daily.csv",  # Alternative
}

# Alternative: Using the raw data we just fetched for AAPL
AAPL_DATA_RAW = """Date,AAPL.Open,AAPL.High,AAPL.Low,AAPL.Close,AAPL.Volume
2015-02-17,127.489998,128.880005,126.919998,127.830002,63152400
2015-02-18,127.629997,128.779999,127.449997,128.720001,44891700
2015-02-19,128.479996,129.029999,128.330002,128.449997,37362400
2015-02-20,128.619995,129.5,128.050003,129.5,48948400
2015-02-23,130.020004,133,129.660004,133,70974100
2015-02-24,132.940002,133.600006,131.169998,132.169998,69228100
2015-02-25,131.559998,131.600006,128.149994,128.789993,74711700
2015-02-26,128.789993,130.869995,126.610001,130.419998,91287500
2015-02-27,130,130.570007,128.240005,128.460007,62014800
2015-03-02,129.25,130.279999,128.300003,129.089996,48096700
2015-03-03,128.960007,129.520004,128.089996,129.360001,37816300
2015-03-04,129.100006,129.559998,128.320007,128.539993,31666300
2015-03-05,128.580002,128.75,125.760002,126.410004,56517100
2015-03-06,128.399994,129.369995,126.260002,126.599998,72842100
2015-03-09,127.959999,129.570007,125.059998,127.139999,88528500
2015-03-10,126.410004,127.220001,123.800003,124.510002,68856600
2015-03-11,124.75,124.769997,122.110001,122.239998,68939000
2015-03-12,122.309998,124.900002,121.629997,124.449997,48362700
2015-03-13,124.400002,125.400002,122.580002,123.589996,51827300
2015-03-16,123.879997,124.949997,122.870003,124.949997,35874300
2015-03-17,125.900002,127.32,125.650002,127.040001,51023100
2015-03-18,127,129.160004,126.370003,128.470001,65270900
2015-03-19,128.75,129.25,127.400002,127.5,45809500
2015-03-20,128.25,128.399994,125.160004,125.900002,68695100
2015-03-23,127.120003,127.849998,126.519997,127.209999,37709700
2015-03-24,127.230003,128.039993,126.559998,126.690002,32842300
2015-03-25,126.540001,126.82,123.379997,123.379997,51655200
2015-03-26,122.760002,124.879997,122.599998,124.239998,47572900
2015-03-27,124.57,124.699997,122.910004,123.25,39546200
2015-03-30,124.050003,126.400002,124,126.370003,47099700
2015-03-31,126.089996,126.489998,124.360001,124.43,42090600
2015-04-01,124.82,125.120003,123.099998,124.25,40621400
2015-04-02,125.029999,125.559998,124.190002,125.32,32220100
2015-04-06,124.470001,127.510002,124.330002,127.349998,37194000
2015-04-07,127.639999,128.119995,125.980003,126.010002,35012300
2015-04-08,125.849998,126.400002,124.970001,125.599998,37329200
2015-04-09,125.849998,126.580002,124.660004,126.559998,32484000
2015-04-10,125.949997,127.209999,125.260002,127.099998,40188000
2015-04-13,128.369995,128.570007,126.610001,126.849998,36365100
2015-04-14,127,127.290001,125.910004,126.300003,25524600
2015-04-15,126.410004,127.129997,126.010002,126.779999,28970400
2015-04-16,126.279999,127.099998,126.110001,126.169998,28369000
2015-04-17,125.550003,126.139999,124.459999,124.75,51957000
2015-04-20,125.57,128.119995,125.169998,127.599998,47054300
2015-04-21,128.100006,128.199997,126.669998,126.910004,32435100
2015-04-22,126.989998,128.869995,126.32,128.619995,37654500
2015-04-23,128.300003,130.419998,128.139999,129.669998,45770900
2015-04-24,130.490005,130.630005,129.229996,130.279999,44525900
2015-04-27,132.309998,133.130005,131.149994,132.649994,96954200
2015-04-28,134.460007,134.539993,129.570007,130.559998,118924000
2015-04-29,130.160004,131.589996,128.300003,128.639999,63386100
2015-04-30,128.639999,128.639999,124.580002,125.150002,83195400
2015-05-01,126.099998,130.130005,125.300003,128.949997,58512600
2015-05-04,129.5,130.570007,128.259995,128.699997,50988300
2015-05-05,128.149994,128.449997,125.779999,125.800003,49271400
2015-05-06,126.559998,126.75,123.360001,125.010002,72141000
2015-05-07,124.769997,126.080002,124.019997,125.260002,43940900
2015-05-08,126.68,127.620003,126.110001,127.620003,55550400
2015-05-11,127.389999,127.559998,125.629997,126.32,42035800
2015-05-12,125.599998,126.879997,124.82,125.870003,48160000
2015-05-13,126.150002,127.190002,125.870003,126.010002,34694200
2015-05-14,127.410004,128.949997,127.160004,128.949997,45203500
2015-05-15,129.070007,129.490005,128.210007,128.770004,38208000
2015-05-18,128.380005,130.720001,128.360001,130.190002,50882900
2015-05-19,130.690002,130.880005,129.639999,130.070007,44633200
2015-05-20,130,130.979996,129.339996,130.059998,36454900
2015-05-21,130.070007,131.630005,129.830002,131.389999,39730400
2015-05-22,131.600006,132.970001,131.399994,132.539993,45596000
2015-05-26,132.600006,132.910004,129.119995,129.619995,70697600
2015-05-27,130.339996,132.259995,130.050003,132.039993,45833200
2015-05-28,131.860001,131.949997,131.100006,131.779999,30733300
2015-05-29,131.229996,131.449997,129.899994,130.279999,50884500
2015-06-01,130.279999,131.389999,130.050003,130.539993,32112800
2015-06-02,129.860001,130.660004,129.320007,129.960007,33667600
2015-06-03,130.660004,130.940002,129.899994,130.119995,30889400
2015-06-04,129.580002,130.580002,128.910004,129.360001,38450100
2015-06-05,129.5,129.690002,128.360001,128.649994,35626800
2015-06-08,128.899994,129.210007,126.830002,127.800003,52674800
2015-06-09,126.699997,128.080002,125.620003,127.419998,56075400
2015-06-10,127.919998,129.339996,127.849998,128.880005,39087300
2015-06-11,129.179993,130.179993,128.479996,128.589996,35390900
2015-06-12,128.190002,128.330002,127.110001,127.169998,36886200
2015-06-15,126.099998,127.239998,125.709999,126.919998,43988900
2015-06-16,127.029999,127.849998,126.370003,127.599998,31494100
2015-06-17,127.720001,127.879997,126.739998,127.300003,32918100
2015-06-18,127.230003,128.309998,127.220001,127.879997,35407200
2015-06-19,127.709999,127.82,126.400002,126.599998,54716900
2015-06-22,127.489998,128.059998,127.080002,127.610001,34039300
2015-06-23,127.480003,127.610001,126.879997,127.029999,30268900
2015-06-24,127.209999,129.800003,127.120003,128.110001,55280900
2015-06-25,128.860001,129.199997,127.5,127.5,31938100
2015-06-26,127.669998,127.989998,126.510002,126.75,44066800
2015-06-29,125.459999,126.470001,124.480003,124.529999,49161400
2015-06-30,125.57,126.120003,124.860001,125.43,44370700
2015-07-01,126.900002,126.940002,125.989998,126.599998,30238800
2015-07-02,126.43,126.690002,125.769997,126.440002,27211000
2015-07-06,124.940002,126.230003,124.849998,126,28060400
2015-07-07,125.889999,126.150002,123.769997,125.690002,46946800
2015-07-08,124.480003,124.639999,122.540001,122.57,60761600
2015-07-09,123.849998,124.059998,119.220001,120.07,77821600
2015-07-10,121.940002,123.849998,121.209999,123.279999,61354500
2015-07-13,125.029999,125.760002,124.32,125.660004,41440500
2015-07-14,126.040001,126.370003,125.040001,125.610001,31768100
2015-07-15,125.720001,127.150002,125.580002,126.82,33649200
2015-07-16,127.739998,128.570007,127.349998,128.509995,36222400
2015-07-17,129.080002,129.619995,128.309998,129.619995,46164700
2015-07-20,130.970001,132.970001,130.699997,132.070007,58900200
2015-07-21,132.850006,132.919998,130.320007,130.75,76756400
2015-07-22,121.989998,125.5,121.989998,125.220001,115450600
2015-07-23,126.199997,127.089996,125.059998,125.160004,50999500
2015-07-24,125.32,125.739998,123.900002,124.5,42162300
2015-07-27,123.089996,123.610001,122.120003,122.769997,44455500
2015-07-28,123.379997,123.910004,122.550003,123.379997,33618100
2015-07-29,123.150002,123.5,122.269997,122.989998,37011700
2015-07-30,122.32,122.57,121.709999,122.370003,33628300
2015-07-31,122.599998,122.639999,120.910004,121.300003,42885000
2015-08-03,121.5,122.57,117.519997,118.440002,69976000
2015-08-04,117.419998,117.699997,113.25,114.639999,124138600
2015-08-05,112.949997,117.440002,112.099998,115.400002,99312600
2015-08-06,115.970001,116.5,114.120003,115.129997,52903000
2015-08-07,114.580002,116.25,114.5,115.519997,38670400
2015-08-10,116.529999,119.989998,116.529999,119.720001,54951600
2015-08-11,117.809998,118.18,113.330002,113.489998,97082800
2015-08-12,112.529999,115.419998,109.629997,115.239998,101217500
2015-08-13,116.040001,116.400002,114.540001,115.150002,48535800
2015-08-14,114.32,116.309998,114.010002,115.959999,42929500
2015-08-17,116.040001,117.650002,115.5,117.160004,40884700
2015-08-18,116.43,117.440002,116.010002,116.5,34560700
2015-08-19,116.099998,116.519997,114.68,115.010002,47445700
2015-08-20,114.080002,114.349998,111.629997,112.650002,68501600
2015-08-21,110.43,111.900002,105.650002,105.760002,128275500
2015-08-24,94.870003,108.800003,92,103.120003,162206300
2015-08-25,111.110001,111.110001,103.5,103.739998,103601600
2015-08-26,107.089996,109.889999,105.050003,109.690002,96774600
2015-08-27,112.230003,113.239998,110.019997,112.919998,84616100
2015-08-28,112.169998,113.309998,111.540001,113.290001,53164400
2015-08-31,112.029999,114.529999,112,112.760002,56229300
2015-09-01,110.150002,111.879997,107.360001,107.720001,76845900
2015-09-02,110.230003,112.339996,109.129997,112.339996,61888800
2015-09-03,112.489998,112.779999,110.040001,110.370003,53233900
2015-09-04,108.970001,110.449997,108.510002,109.269997,49996300
2015-09-08,111.75,112.559998,110.32,112.309998,54843600
2015-09-09,113.760002,114.019997,109.769997,110.150002,85010800
2015-09-10,110.269997,113.279999,109.900002,112.57,62892800
2015-09-11,111.790001,114.209999,111.760002,114.209999,49915500
2015-09-14,116.580002,116.889999,114.860001,115.309998,58363400
2015-09-15,115.93,116.529999,114.419998,116.279999,43341200
2015-09-16,116.25,116.540001,115.440002,116.410004,37173500
2015-09-17,115.660004,116.489998,113.720001,113.919998,64112600
2015-09-18,112.209999,114.300003,111.870003,113.449997,74285300
2015-09-21,113.669998,115.370003,113.660004,115.209999,50222000
2015-09-22,113.379997,114.18,112.519997,113.400002,50346200
2015-09-23,113.629997,114.720001,113.300003,114.32,35756700
2015-09-24,113.25,115.5,112.370003,115,50219500
2015-09-25,116.440002,116.690002,114.019997,114.709999,56151900
2015-09-28,113.849998,114.57,112.440002,112.440002,52109000
2015-09-29,112.830002,113.510002,107.860001,109.059998,73365400
2015-09-30,110.169998,111.540001,108.730003,110.300003,66473000
2015-10-01,109.07,109.620003,107.309998,109.580002,63929100
2015-10-02,108.010002,111.010002,107.550003,110.379997,58019800
2015-10-05,109.879997,111.370003,109.07,110.779999,52064700
2015-10-06,110.629997,111.739998,109.769997,111.309998,48196800
2015-10-07,111.739998,111.769997,109.410004,110.779999,46765600
2015-10-08,110.190002,110.190002,108.209999,109.5,61979600
2015-10-09,110,112.279999,109.489998,112.120003,52766100
2015-10-12,112.730003,112.75,111.440002,111.599998,30467200
2015-10-13,111.779999,112.279999,110.529999,111.599998,30733300
2015-10-14,111.839996,112.339996,110.209999,111.75,33613800
2015-10-15,112.379997,114.169998,111.82,113.769997,47023900
2015-10-16,114.419998,114.919998,113.660004,114.709999,39771300
2015-10-19,115.160004,116.18,114.639999,115.00,37100400
2015-10-20,114.919998,117.57,114.120003,116.599998,48701100
2015-10-21,116.370003,116.730003,115.589996,116.519997,32841300
2015-10-22,116.849998,118.099998,116.599998,117.750000,58148800
2015-10-23,118.080002,120.290001,118.080002,119.080002,57582000
"""


def parse_csv_data(csv_content: str, symbol: str = "UNKNOWN") -> list:
    """Parse CSV content into OHLCV data format."""
    data = []
    
    reader = csv.DictReader(io.StringIO(csv_content))
    
    for row in reader:
        try:
            # Handle different CSV formats
            date = row.get('Date', row.get('date', ''))
            
            # Try different column name patterns
            open_price = float(row.get(f'{symbol}.Open', row.get('AAPL.Open', row.get('Open', row.get('open', 0)))))
            high_price = float(row.get(f'{symbol}.High', row.get('AAPL.High', row.get('High', row.get('high', 0)))))
            low_price = float(row.get(f'{symbol}.Low', row.get('AAPL.Low', row.get('Low', row.get('low', 0)))))
            close_price = float(row.get(f'{symbol}.Close', row.get('AAPL.Close', row.get('Close', row.get('close', 0)))))
            volume = int(float(row.get(f'{symbol}.Volume', row.get('AAPL.Volume', row.get('Volume', row.get('volume', 1000000))))))
            
            if open_price > 0 and close_price > 0:
                data.append({
                    "date": date,
                    "open": open_price,
                    "high": high_price,
                    "low": low_price,
                    "close": close_price,
                    "volume": volume
                })
        except (ValueError, KeyError) as e:
            continue
    
    return data


def fetch_from_url(url: str) -> str:
    """Fetch CSV data from URL."""
    try:
        with urlopen(url, timeout=30) as response:
            return response.read().decode('utf-8')
    except URLError as e:
        print(f"Error fetching URL: {e}")
        return ""


def run_real_data_backtest():
    """Run backtest on real AAPL data."""
    
    print("=" * 80)
    print("UMCI REAL DATA BACKTEST - APPLE INC (AAPL)")
    print("=" * 80)
    print(f"Data Period: Feb 2015 - Oct 2015")
    print(f"Source: Plotly Public Dataset (GitHub)")
    print(f"Initial Capital: 100,000 USD")
    print("=" * 80)
    
    # Parse the embedded real data
    data = parse_csv_data(AAPL_DATA_RAW)
    
    print(f"\nLoaded {len(data)} bars of REAL historical data")
    print(f"Date Range: {data[0]['date']} to {data[-1]['date']}")
    print(f"Price Range: ${min(d['close'] for d in data):.2f} - ${max(d['close'] for d in data):.2f}")
    
    # Run backtest with default config
    config = BacktestConfig(initial_capital=100000)
    
    print("\nRunning backtest...")
    results = run_backtest(data, config)
    
    if results and results.total_trades > 0:
        print_results(results, "AAPL (Real Data)")
        
        # Generate detailed trade list
        print("\n" + "=" * 80)
        print("DETAILED TRADE LOG")
        print("=" * 80)
        print(f"{'#':>3} {'Entry Date':<12} {'Exit Date':<12} {'Type':>6} {'Entry $':>10} {'Exit $':>10} {'P&L':>12} {'Result':>8}")
        print("-" * 80)
        
        for i, trade in enumerate(results.trades, 1):
            result = "WIN" if trade.pnl > 0 else "LOSS"
            print(f"{i:>3} {trade.entry_date:<12} {trade.exit_date:<12} {trade.direction:>6} {trade.entry_price:>10.2f} {trade.exit_price:>10.2f} {trade.pnl:>12.2f} {result:>8}")
        
        print("=" * 80)
        
        # Return summary
        return {
            "symbol": "AAPL",
            "data_source": "Plotly GitHub Dataset (Real Historical Data)",
            "period": f"{data[0]['date']} to {data[-1]['date']}",
            "total_bars": len(data),
            "initial_capital": 100000,
            "results": {
                "total_trades": results.total_trades,
                "winning_trades": results.winning_trades,
                "losing_trades": results.losing_trades,
                "win_rate": round(results.win_rate, 2),
                "profit_factor": round(results.profit_factor, 2),
                "total_pnl": round(results.total_pnl, 2),
                "total_return_percent": round(results.total_return_percent, 2),
                "max_drawdown_percent": round(results.max_drawdown_percent, 2),
                "sharpe_ratio": round(results.sharpe_ratio, 2),
                "avg_win": round(results.avg_win, 2),
                "avg_loss": round(results.avg_loss, 2),
                "max_consecutive_wins": results.max_consecutive_wins,
                "max_consecutive_losses": results.max_consecutive_losses
            },
            "trades": [
                {
                    "entry_date": t.entry_date,
                    "exit_date": t.exit_date,
                    "direction": t.direction,
                    "entry_price": round(t.entry_price, 2),
                    "exit_price": round(t.exit_price, 2),
                    "pnl": round(t.pnl, 2),
                    "pnl_percent": round(t.pnl_percent, 2),
                    "exit_reason": t.exit_reason
                }
                for t in results.trades
            ]
        }
    else:
        print("No trades generated during backtest period")
        return None


def main():
    """Main entry point."""
    import argparse
    
    parser = argparse.ArgumentParser(description='UMCI Real Data Backtesting')
    parser.add_argument('--output', type=str, default=None,
                       help='Output JSON file for results')
    
    args = parser.parse_args()
    
    results = run_real_data_backtest()
    
    if results and args.output:
        with open(args.output, 'w') as f:
            json.dump(results, f, indent=2)
        print(f"\nResults saved to {args.output}")
    
    return results


if __name__ == "__main__":
    main()
