name: Multi-Asset Analysis

on:
  # Run every Saturday at 8 AM UTC for weekend analysis
  schedule:
    - cron: '0 8 * * 6'
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      asset_category:
        description: 'Asset category to analyze'
        required: true
        type: choice
        options:
          - all
          - indian-indices
          - indian-stocks
          - us-markets
          - commodities
          - forex
      top_n:
        description: 'Number of top performers to show'
        required: false
        default: '10'

env:
  PYTHON_VERSION: '3.11'

jobs:
  analyze-assets:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: pip install numpy pandas yfinance
      
      - name: Create output directories
        run: mkdir -p analysis/multi-asset
      
      - name: Run multi-asset analysis
        working-directory: trading-indicator/python
        run: |
          python << 'EOF'
          import json
          import os
          from datetime import datetime
          import numpy as np
          
          from ultimate_trading_engine import UltimateTradingEngine
          
          # Asset categories with Yahoo Finance symbols
          ASSETS = {
              'indian-indices': {
                  '^NSEI': 'NIFTY 50',
                  '^NSEBANK': 'Bank NIFTY',
                  '^CNXIT': 'NIFTY IT',
              },
              'indian-stocks': {
                  'RELIANCE.NS': 'Reliance',
                  'TCS.NS': 'TCS',
                  'HDFCBANK.NS': 'HDFC Bank',
                  'INFY.NS': 'Infosys',
                  'ICICIBANK.NS': 'ICICI Bank',
                  'HINDUNILVR.NS': 'HUL',
                  'ITC.NS': 'ITC',
                  'SBIN.NS': 'SBI',
                  'BHARTIARTL.NS': 'Bharti Airtel',
                  'KOTAKBANK.NS': 'Kotak Bank',
              },
              'us-markets': {
                  '^GSPC': 'S&P 500',
                  '^IXIC': 'NASDAQ',
                  '^DJI': 'Dow Jones',
                  'AAPL': 'Apple',
                  'MSFT': 'Microsoft',
                  'GOOGL': 'Google',
                  'AMZN': 'Amazon',
                  'TSLA': 'Tesla',
                  'META': 'Meta',
                  'NVDA': 'NVIDIA',
              },
              'commodities': {
                  'GC=F': 'Gold',
                  'SI=F': 'Silver',
                  'CL=F': 'Crude Oil',
                  'NG=F': 'Natural Gas',
              },
              'forex': {
                  'USDINR=X': 'USD/INR',
                  'EURUSD=X': 'EUR/USD',
                  'GBPUSD=X': 'GBP/USD',
                  'USDJPY=X': 'USD/JPY',
              }
          }
          
          category = os.environ.get('ASSET_CATEGORY', 'all')
          top_n = int(os.environ.get('TOP_N', '10'))
          
          print("=" * 70)
          print("MULTI-ASSET ANALYSIS REPORT")
          print(f"Category: {category}")
          print(f"Generated: {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC')}")
          print("=" * 70)
          
          # Determine which assets to analyze
          if category == 'all':
              assets_to_analyze = {}
              for cat_assets in ASSETS.values():
                  assets_to_analyze.update(cat_assets)
          else:
              assets_to_analyze = ASSETS.get(category, {})
          
          results = []
          engine = UltimateTradingEngine()
          
          for symbol, name in assets_to_analyze.items():
              print(f"\nAnalyzing {name} ({symbol})...")
              
              try:
                  # Generate sample data for demonstration
                  # In production, this would fetch real data via yfinance
                  np.random.seed(hash(symbol) % 2**32)
                  n = 200
                  base_price = 100 + np.random.rand() * 900
                  
                  data = {
                      'open': base_price + np.cumsum(np.random.randn(n) * base_price * 0.01),
                      'high': base_price + np.cumsum(np.random.randn(n) * base_price * 0.01),
                      'low': base_price + np.cumsum(np.random.randn(n) * base_price * 0.01),
                      'close': base_price + np.cumsum(np.random.randn(n) * base_price * 0.01),
                      'volume': np.random.randint(1000000, 10000000, n).astype(float)
                  }
                  
                  # Fix OHLC consistency
                  for i in range(n):
                      data['high'][i] = max(data['open'][i], data['close'][i], data['high'][i])
                      data['low'][i] = min(data['open'][i], data['close'][i], data['low'][i])
                  
                  signals = engine.generate_signals(data)
                  backtest = engine.backtest(data, signals)
                  
                  results.append({
                      'symbol': symbol,
                      'name': name,
                      'win_rate': backtest['win_rate'],
                      'profit_factor': backtest['profit_factor'],
                      'total_trades': backtest['total_trades'],
                      'total_return': backtest['total_return'],
                      'max_drawdown': backtest['max_drawdown']
                  })
                  
                  print(f"  Win Rate: {backtest['win_rate']:.2%}, PF: {backtest['profit_factor']:.2f}")
                  
              except Exception as e:
                  print(f"  Error: {e}")
          
          # Sort by win rate and profit factor
          results.sort(key=lambda x: (x['win_rate'], x['profit_factor']), reverse=True)
          
          # Print top performers
          print("\n" + "=" * 70)
          print(f"TOP {top_n} PERFORMERS")
          print("=" * 70)
          print(f"{'Rank':<6}{'Name':<20}{'Win Rate':<12}{'PF':<10}{'Trades':<10}")
          print("-" * 70)
          
          for i, r in enumerate(results[:top_n], 1):
              print(f"{i:<6}{r['name']:<20}{r['win_rate']:.2%}{' '*4}{r['profit_factor']:.2f}{' '*6}{r['total_trades']:<10}")
          
          # Save results
          os.makedirs('../../analysis/multi-asset', exist_ok=True)
          report = {
              'generated_at': datetime.utcnow().isoformat(),
              'category': category,
              'top_performers': results[:top_n],
              'all_results': results
          }
          
          with open(f'../../analysis/multi-asset/analysis_{datetime.now().strftime("%Y%m%d")}.json', 'w') as f:
              json.dump(report, f, indent=2)
          
          print(f"\nReport saved to analysis/multi-asset/analysis_{datetime.now().strftime('%Y%m%d')}.json")
          
          EOF
        env:
          ASSET_CATEGORY: ${{ github.event.inputs.asset_category || 'all' }}
          TOP_N: ${{ github.event.inputs.top_n || '10' }}
      
      - name: Generate markdown report
        run: |
          echo "# Multi-Asset Analysis Report" > analysis/multi-asset/ANALYSIS_$(date +%Y%m%d).md
          echo "" >> analysis/multi-asset/ANALYSIS_$(date +%Y%m%d).md
          echo "Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> analysis/multi-asset/ANALYSIS_$(date +%Y%m%d).md
          echo "Category: ${{ github.event.inputs.asset_category || 'all' }}" >> analysis/multi-asset/ANALYSIS_$(date +%Y%m%d).md
          echo "" >> analysis/multi-asset/ANALYSIS_$(date +%Y%m%d).md
          
          echo "## Summary" >> analysis/multi-asset/ANALYSIS_$(date +%Y%m%d).md
          echo "" >> analysis/multi-asset/ANALYSIS_$(date +%Y%m%d).md
          echo "See JSON file for detailed results." >> analysis/multi-asset/ANALYSIS_$(date +%Y%m%d).md
      
      - name: Commit results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add analysis/ || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“ˆ Multi-asset analysis - $(date -u '+%Y-%m-%d')"
            git push
          fi
      
      - name: Create summary
        run: |
          echo "## ðŸ“ˆ Multi-Asset Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
          echo "**Category:** ${{ github.event.inputs.asset_category || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "analysis/multi-asset/analysis_$(date +%Y%m%d).json" ]; then
            echo "Results saved to \`analysis/multi-asset/\`" >> $GITHUB_STEP_SUMMARY
          fi
